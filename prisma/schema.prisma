generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Turma {
  id          String     @id @default(uuid())
  nome        String
  ano_letivo  Int
  alunos      Aluno[]
  provas      Prova[]
  userId      String?    @map("user_id")
  user        users?     @relation(fields: [userId], references: [id])

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt
}

model Aluno {
  id         String   @id @default(uuid())
  nome       String
  turmaId    String   @map("turma_id")
  turma      Turma    @relation(fields: [turmaId], references: [id])
  notas      Nota[]
  userAccount   users?

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt
}

model AlunoCredential {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  username        String   @unique
  passwordHash    String
  mustChangePassword Boolean @default(true)
  lastLogin       DateTime?
}

model Materia {
  id                String              @id @default(uuid())
  nome              String
  userId            String?             @map("user_id")
  user              users?              @relation(fields: [userId], references: [id])
  simuladoMaterias  SimuladoMateria[]
  provas            Prova[]
  criado_em         DateTime            @default(now())
  atualizado_em     DateTime            @updatedAt

  @@unique([nome, userId])
}

enum TipoProva {
  COMUM
  SIMULADO
}

enum UserRole {
  PROFESSOR
  ALUNO
}

model SimuladoMateria {
  id        String   @id @default(uuid())
  provaId   String   @map("prova_id")
  materiaId String   @map("materia_id")
  peso      Decimal  @db.Decimal(5, 2)

  prova     Prova    @relation(fields: [provaId], references: [id], onDelete: Cascade)
  materia   Materia  @relation(fields: [materiaId], references: [id], onDelete: Cascade)
  notas     Nota[]

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  @@unique([provaId, materiaId])
  @@map("simulado_materia")
}

model Prova {
  id                String              @id @default(uuid())
  nome              String
  turmaId           String              @map("turma_id")
  turma             Turma               @relation(fields: [turmaId], references: [id])
  ano_letivo        Int
  peso              Decimal             @db.Decimal(5, 2)
  tipo              TipoProva
  data_prova        DateTime?
  userId            String?             @map("user_id")
  user              users?              @relation(fields: [userId], references: [id])
  materiaId         String?             @map("materia_id")
  materia           Materia?            @relation(fields: [materiaId], references: [id])
  simuladoMaterias  SimuladoMateria[]
  notas             Nota[]
  publicada         Boolean             @default(false)
  dataPublicacao    DateTime?

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt
}

model Nota {
  id                  String            @id @default(uuid())
  alunoId             String            @map("aluno_id")
  provaId             String            @map("prova_id")
  simuladoMateriaId   String?           @map("simulado_materia_id")
  valor_nota          Decimal           @db.Decimal(5, 2)
  data_lancada        DateTime          @default(now())

  aluno             Aluno             @relation(fields: [alunoId], references: [id])
  prova             Prova             @relation(fields: [provaId], references: [id])
  simuladoMateria   SimuladoMateria?  @relation(fields: [simuladoMateriaId], references: [id], onDelete: Cascade)

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  @@unique([alunoId, provaId, simuladoMateriaId])
}

model users {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  status        Boolean?   @default(true)
  stripe_customer_id String?
  subscription  Subscription?
  accounts      accounts[]
  sessions      sessions[]
  turmas        Turma[]
  materias      Materia[]
  provas        Prova[]
  role          UserRole  @default(PROFESSOR)
  alunoId       String?   @unique
  aluno         Aluno?    @relation(fields: [alunoId], references: [id])
  alunoCredential AlunoCredential?
}

model accounts {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model verification_tokens {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

enum Plan {
  BASIC
  PROFESSIONAL
}

model Subscription {
  id        String   @id @default(uuid())
  status    String
  plan      Plan
  priceId   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt
  userId    String   @unique
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model sessions {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}
